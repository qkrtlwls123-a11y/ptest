<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Survey">
	<sql id="survey_list_where">
		<if test='s_survey_nm !=null and s_survey_nm !=""'>
	 			AND A.SURVEY_NM LIKE CONCAT('%',#{s_survey_nm},'%')
	 	</if>
	 	<if test='s_use_yn != null and s_use_yn != ""'>
			AND	A.USE_YN = #{s_use_yn}
		</if>
		<if test='s_company_code != null and s_company_code != ""'>
			AND	A.COMPANY_CODE = #{s_company_code}
		</if>
		<if test='period == "yesterday"'>
			AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') = DATE_FORMAT(now() -INTERVAL 1 DAY, '%Y-%m-%d')
		</if>
		<if test='period=="today"'>
			AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') = DATE_FORMAT(now(), '%Y-%m-%d') 
		</if>
		<if test='period=="custom_date"'>
			<if test="s_start_dt != null and s_start_dt != '' and s_end_dt != null and s_end_dt != ''">
				AND DATE_FORMAT(A.REG_DT, '%Y-%m-%d') BETWEEN #{s_start_dt} AND #{s_end_dt}
			</if>
		</if>
	</sql>
	
	<!-- 전체설문조회 -->
	<select id="selectSurveyList" parameterType="box" resultType="box">
		SELECT
			 A.id
			, A.survey_nm
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, B.user_nm as reg_nm
			, B.business_no as business_no
		FROM TB_SURVEY A 
			LEFT OUTER JOIN SV_USER B ON A.REG_ID = B.ID
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
			WHERE 1=1
		<include refid="survey_list_where"/>
		ORDER BY ID DESC
		LIMIT ${numPerPage} OFFSET ${startRow}
	</select>

	<select id="selectSurveyListCount" parameterType="box" resultType="Integer">
		SELECT
			 COUNT(*) AS TOTAL_CNT
		FROM
			TB_SURVEY A 
		WHERE 1=1
		<include refid="survey_list_where"/>
	</select>
	
	<!-- 설문상세뷰 -->
	<select id="getSurveyView" parameterType="box" resultType="box">
		SELECT 
			A.id
			, A.survey_nm
			, A.survey_info
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, B.user_nm as reg_nm
			, b.business_no as business_no
		FROM TB_SURVEY A 
			LEFT OUTER JOIN SV_USER B ON A.REG_ID = B.ID
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
		WHERE A.id = #{id}
	</select>
	
	<!-- 설문 Insert -->
	<insert id="surveyInsert" parameterType="box">
	   INSERT INTO TB_SURVEY (survey_nm, reg_id, reg_dt,edit_id,edit_dt)  VALUES 
	        (trim(#{survey_nm}), #{mem_id},now(),#{mem_id},now())
	</insert>
	
	<!-- 설문 Update -->
	<update id="surveyUpdate" parameterType="box" >
	   UPDATE TB_SURVEY set
		   survey_nm = trim(#{survey_nm})
		   , survey_info = #{survey_info}
		   , edit_id = #{mem_id}
		   , edit_dt = now()
	   WHERE id = #{id}
	</update>
	
	<!-- 설문 Delete -->
	<delete id="surveyDelete" parameterType="box">
	   DELETE FROM TB_SURVEY
	   WHERE id = #{id}
	</delete>
	
	<!-- 현재 설문을 참조하는 질의가 있는지 Count -->
	<select id="lowDepthCount" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_INQUIRY
		WHERE SURVEY_ID = #{s_survey_id}
	</select>
</mapper>
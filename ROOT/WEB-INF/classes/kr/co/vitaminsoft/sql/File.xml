<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="File">
	
	<!-- 글하나에 속한 파일 리스트-->
	<select id="getFileList" parameterType="box" resultType="box">
		SELECT id
			,program_code
			,program_id
			,file_type
			,file_nm
			,file_path
			,file_size
			,file_desc
			,is_list_img
			,is_detail_img
			,use_yn
			,use_type
			,reg_id
			,DATE_FORMAT(REG_DT, '%Y-%m-%d') reg_dt
			,edit_id
			,DATE_FORMAT(edit_dt, '%Y-%m-%d') edit_dt
		FROM TB_FILE
		WHERE PROGRAM_CODE = #{up_code}
		AND PROGRAM_ID = #{id}
		<if test="use_yn != 'ALL' ">
			AND USE_YN = 'Y'
		</if>
		
		<if test='s_is_list_img != null and s_is_list_img.equals("Y")'>
			AND IS_LIST_IMG = #{s_is_list_img}
		</if>
		<if test='s_is_list_img != null and s_is_list_img.equals("N")'>
			AND (IS_LIST_IMG != 'Y' OR IS_LIST_IMG IS NULL)
		</if>
		ORDER BY REG_DT ASC
	</select>
	
	<!-- 파일상세뷰 -->
	<select id="getFileView" parameterType="box" resultType="box">
		SELECT
			id	
			,program_code
			,program_id
			,file_type
			,file_nm
			,file_path
			,file_size
			,file_desc
			,use_yn
			,is_list_img
			,is_detail_img
			,reg_id
			,reg_dt
			,edit_id
			,edit_dt
		FROM TB_FILE 
<!-- 		WHERE cast(id as VARCHAR(30)) = #{id} -->
		WHERE ID = #{id}
<!-- 		WHERE ID = #{file_id} -->
	</select>
	
	<!--  게시판 조건별 Count -->
	<select id="getFileListCount" resultType="Integer">
		SELECT
			COUNT(*) AS total_cnt
		FROM TB_FILE
		WHERE program_code = #{program_code}
		<choose>
			<when test="temp_id != null and temp_id != ''">
				AND program_id = #{temp_id}
			</when>
			<when test="program_id != null and program_id != ''">
				AND program_id = #{program_id}
			</when>
			<otherwise>
				AND program_id = #{id}
			</otherwise>
		</choose>
	</select>
	
	<!-- 파일 Insert -->
	<insert id="fileInsert" parameterType="box">
	   INSERT INTO TB_FILE 
	   (
	   program_code, 
	   program_id, 
	   file_type, 
	   file_nm, 
	   file_path, 
	   file_size, 
	   file_desc, 
	   <if test='upFileNum != null and upFileNum.equals("0")'>
	   is_list_img,
	   </if>
	   use_yn, 
	   use_type, 
	   reg_id, 
	   reg_dt,
	   edit_id,
	   edit_dt
	   )  
	  VALUES 
	   (
	   #{program_code}, 
	   #{program_id}, 
	   #{file_type}, 
	   #{file_nm}, 
	   #{file_path}, 
	   #{file_size}, 
	   #{file_desc},
	   <if test='upFileNum != null and upFileNum.equals("0")'>
	   'Y',
	   </if>
	   'Y',
	   #{use_type},
	   #{mem_id},
	   now(),
	   #{mem_id},
	   now()
	   )
	   <selectKey resultType="int" keyProperty="insertFileId" order="AFTER">
        SELECT LAST_INSERT_ID()
   	   </selectKey> 
	</insert>

	<!-- 파일 Update -->
	<update id="fileUpdate" parameterType="box" >
	   UPDATE TB_FILE set
	  		edit_id = #{mem_id}
		   ,edit_dt = now()
<!-- 	   	<if test="program_code != null and program_code != '' ">
		   ,program_code = #{program_code}
		</if>
		<if test="program_id != null and program_id != '' ">
		   ,program_id = #{program_id}
		</if> -->
		<if test="file_type != null and file_type != '' ">
		   ,file_type = #{file_type}
		</if>
		<if test="file_nm != null and file_nm != '' ">   
		   ,file_nm = #{file_nm}
		</if>
		<if test="file_path != null and file_path != '' ">
		   ,file_path = #{file_path}
		</if>
		<if test="file_size != null and file_size != '' ">
		   ,file_size = #{file_size}
		</if>
		<if test="file_desc != null and file_desc != '' ">
		   ,file_desc = #{file_desc}
		</if>
		<if test="use_yn != null and use_yn != '' ">
		   ,use_yn = #{use_yn}
		</if>
<!-- 		<if test="mem_id != null and mem_id != '' ">
		   ,edit_id = #{mem_id}
		   ,edit_dt = now()
		</if> -->
<!-- 	   WHERE cast(id as VARCHAR(30)) = #{id} -->
	   WHERE PROGRAM_ID = #{id}
	</update>

	<!-- 파일 Update 임시로 만들어진 글참조 아이디를 실제 등록된 아이디로 변경 -->
	<update id="fileProgramIdUpdate" parameterType="box">
	   UPDATE TB_FILE set
		   program_id = #{program_id}
		   ,edit_id = #{mem_id}
		   ,edit_dt = now()
	   WHERE program_code = #{program_code}
	   AND program_id = #{temp_id}
	</update>
	
	<!-- 프로그램 코드와 프로그램 아이디로 등록된 파일의 속성을 모두 N으로 업데이트 시킨 -->
	<update id="updateFileModeSetN" parameterType="box">
	   UPDATE TB_FILE set
	   	   <if test="action_mode == 'setList' ">
		   		is_list_img = 'N'
		   </if>
	   	   <if test="action_mode == 'setDetail' ">
		   		is_detail_img = 'N'
		   </if>
		   ,edit_id = #{mem_id}
		   ,edit_dt = now()
	   WHERE program_code = #{program_code}
	   AND program_id = #{program_id}
	</update>
	
	<!-- 프로그램 코드와 프로그램 아이디로 등록된 파일의 속성을 모두 N으로 업데이트 시킨 -->
	<update id="updateFileMode" parameterType="box">
	   UPDATE TB_FILE set
	   	   <if test="action_mode == 'setList' ">
		   		is_list_img = 'Y'
		   </if>
	   	   <if test="action_mode == 'setDetail' ">
		   		is_detail_img = 'Y'
		   </if>
		   ,edit_id = #{mem_id}
		   ,edit_dt = now()
<!-- 	   WHERE cast(id as VARCHAR(30)) = #{id} -->
	   WHERE ID = #{file_id}
	</update>
	
	<!-- 파일 Delete -->
	<delete id="fileDelete" parameterType="box">
	   DELETE FROM TB_FILE WHERE 
<!-- 	   cast(id as VARCHAR(30)) = #{id} -->
	 	ID = #{id}
	 	<!-- ID = #{file_id} -->
	</delete>
</mapper>
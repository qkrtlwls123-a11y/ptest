<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Code">
	<sql id="code_list_where">
		<if test="s_code != null and s_code != '' ">
			AND A.CODE LIKE CONCAT('%', #{s_code}, '%')
		</if>
		<if test="s_code_nm != null and s_code_nm != '' ">
			AND A.CODE_NM LIKE CONCAT('%', #{s_code_nm}, '%')
		</if> 
		<if test="s_use_yn != null and s_use_yn != '' ">
			AND A.USE_YN = #{s_use_yn}
		</if>
		<if test="s_up_code != null and s_up_code != '' ">
			AND A.UP_CODE = #{s_up_code}
		</if>
	</sql>
	
	<!-- 전체코드조회 -->
	<select id="selectCodeList" parameterType="box" resultType="box">
		SELECT
			 A.code
			, A.code_nm
			, A.up_code
			, A.code_level
			, A.sort_seq as sort_num
			, A.use_yn
			, A.reserve1
			, B.user_nm as reg_nm
			, A.reg_id
			, DATE_FORMAT(A.REG_DT, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.EDIT_DT, '%Y-%m-%d') as edit_dt
		FROM
			SV_CODE A LEFT OUTER JOIN SV_USER B ON A.REG_ID = B.ID
			WHERE 1=1
		<include refid="code_list_where"/>
		ORDER BY A.UP_CODE,A.SORT_SEQ
		LIMIT ${numPerPage} OFFSET ${startRow}
	</select>

	<select id="selectCodeListCount" parameterType="box" resultType="Integer">
		SELECT
			 COUNT(*) AS TOTAL_CNT
		FROM
			SV_CODE A
		WHERE 1=1
		<include refid="code_list_where"/>
	</select>
	
	<!-- 서브코드 조회 -->
	<select id="getSubCodeList" parameterType="box" resultType="box">
		SELECT up_code
			  ,code
			  ,code_nm
			  ,code_level
			  ,sort_seq
			  ,use_yn
		FROM SV_CODE
		WHERE UP_CODE = #{up_code}
		AND USE_YN = 'Y'
		ORDER BY SORT_SEQ ASC
	</select>
	
	<!-- 코드상세뷰 -->
	<select id="getCodeView" parameterType="box" resultType="box">
		SELECT 
			A.up_code
			,A.code
			,A.code_nm
			,A.code_level
			,A.sort_seq
			,A.use_yn
			,A.reserve1
			,A.reg_id
			,DATE_FORMAT(A.REG_DT, '%Y-%m-%d') as reg_dt
			,A.edit_id
			,DATE_FORMAT(A.EDIT_DT, '%Y-%m-%d') as edit_dt
		FROM SV_CODE A
		WHERE 	UP_CODE = #{up_code} 
		AND code = #{code}
	</select>
	
	<select id="getSortCount" parameterType="box" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM SV_CODE
		WHERE 1=1
		<choose>
			<when test="up_code != null and up_code != ''">
				AND UP_CODE = #{up_code}
			</when>
			<otherwise>
				AND CODE_LEVEL = 1
			</otherwise>
		</choose>
	</select>
	
	<!-- 현재 코드를 참조하는 하위코드가 있는지 Count -->
	<select id="lowDepthCount" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM SV_CODE
		WHERE UP_CODE = #{code}
		AND CODE_LEVEL = (${code_level} + 1)
		<!-- <choose>
			<when test="code_level != null and code_level != ''">
				AND UP_CODE = #{up_code}
				AND CODE_LEVEL = (${code_level} + 1)
			</when>
			<otherwise>
				AND CODE_LEVEL = 1
			</otherwise>
		</choose> -->
	</select>
	
	<!-- 코드 Insert -->
	<insert id="codeInsert" parameterType="box">
	   <![CDATA[
	   INSERT INTO SV_CODE (up_code, code, code_nm, code_level, sort_seq, use_yn, reserve1, reg_id, reg_dt,edit_id,edit_dt)  VALUES 
	        (#{up_code}, trim(#{code}), trim(#{code_nm}), #{code_level}, #{sort_seq}, #{use_yn}, #{reserve1},#{mem_id},now(),#{mem_id},now())
	   ]]>
	</insert>
	
	<!-- 코드 정렬 스텝1 Update -->
	<update id="sortCode1" parameterType="box" >
	   <![CDATA[
	   UPDATE SV_CODE set sort_seq = sort_seq * 1000 
	   WHERE UP_CODE = #{up_code}
	   ]]>
	</update>
	
	<!-- 코드 정렬 스텝2 Update  -->
	<update id="sortCode2" parameterType="box" >
	   UPDATE SV_CODE set SORT_SEQ = ${num} * 1000 
	   <choose>
	   	<when test="pnum &lt;= num">
	   		+1
	   	</when>
	   	<when test="original_sort != '' and original_sort &lt; num">
	   		+1
	   	</when>
	   	<otherwise>
	   		-1
	   	</otherwise>
	   </choose>
	   WHERE UP_CODE = #{up_code} and code = #{code}
	</update>
	
	<!-- 코드 정렬 스텝3 Update  -->
	<update id="sortCode3" parameterType="box">
	   UPDATE SV_CODE set SORT_SEQ = ${sort_seq}
	   WHERE UP_CODE = #{up_code} and code = #{code}
	</update>
	
	<!-- autoSort용 코드리스트  -->
	<select id="getSortCodeList" parameterType="box" resultType="box">
		SELECT up_code,code,sort_seq
		FROM SV_CODE
		WHERE UP_CODE = #{up_code}
		ORDER BY SORT_SEQ ASC
	</select>
	
	<!-- 코드 Update -->
	<update id="codeUpdate" parameterType="box" >
	   UPDATE SV_CODE set
		   CODE_NM = trim(#{code_nm})
		   ,SORT_SEQ = ${sort}
		   ,USE_YN = #{use_yn}
		   ,RESERVE1 = #{reserve1}
		   ,EDIT_ID = #{mem_id}
		   ,EDIT_DT = now()
	   WHERE UP_CODE = #{up_code} AND CODE = trim(#{code})
	</update>
	
	<!-- 코드 Delete -->
	<delete id="codeDelete" parameterType="box">
	   DELETE FROM SV_CODE
	   WHERE UP_CODE = #{up_code} AND CODE = #{code}
	</delete>
	
</mapper>
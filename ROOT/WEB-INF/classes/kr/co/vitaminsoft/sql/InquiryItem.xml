<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="InquiryItem">
	<sql id="item_list_where">
		<if test="s_item_sentence != null and s_item_sentence != '' ">
			AND A.ITEM_SENTENCE LIKE CONCAT('%', #{s_item_sentence}, '%')
		</if>
		<if test="s_item_type != null and s_item_type != '' ">
			AND A.ITEM_TYPE = #{s_item_type}
		</if>
		<if test="s_inquiry_id != null and s_inquiry_id != '' ">
			AND A.INQUIRY_ID = #{s_inquiry_id}
		</if>
	</sql>
	
	<!-- 전체아이템항목조회 -->
	<select id="selectItemList" parameterType="box" resultType="box">
		SELECT
			 A.id
			, A.inquiry_id
			, B.survey_id
			, A.item_sentence
			, A.item_no
			, IFNULL(A.col_no,0) as col_no
			, A.item_type
			, (SELECT COUNT(*) FROM TB_INQUIRY_ITEM TT1 WHERE TT1.inquiry_id = A.inquiry_id) AS item_max_no
			, A.estimation_yn
			, A.reverse_score_yn
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, C.code_nm as item_type_nm
		FROM
			TB_INQUIRY_ITEM A INNER JOIN TB_INQUIRY B ON A.INQUIRY_ID=B.ID
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
			LEFT OUTER JOIN SV_CODE C ON C.UP_CODE = 'ITEM_TYPE' AND C.CODE = A.ITEM_TYPE
			WHERE 1=1
		<include refid="item_list_where"/>
		ORDER BY item_no
		LIMIT ${numPerPage} OFFSET ${startRow}
	</select>

	<select id="selectItemListCount" parameterType="box" resultType="Integer">
		SELECT
			 COUNT(*) AS TOTAL_CNT
		FROM
			TB_INQUIRY_ITEM A
		WHERE 1=1
		<include refid="item_list_where"/>
	</select>
	
	<!-- autoSort용 아이템항목리스트  -->
	<select id="getSortItemList" parameterType="box" resultType="box">
		SELECT id
		FROM TB_INQUIRY_ITEM
		WHERE INQUIRY_ID = #{s_inquiry_id}
		ORDER BY ITEM_NO ASC
	</select>
	
	<!-- autoSort용 아이템항목리스트  -->
	<select id="getSortColNumList" parameterType="box" resultType="box">
		SELECT T1.id
		FROM TB_INQUIRY_ITEM T1 INNER JOIN TB_INQUIRY T2 ON T1.INQUIRY_ID=T2.ID
		WHERE 	T2.SURVEY_ID = #{s_survey_id}
		ORDER BY T1.COL_NO ASC
	</select>
	
	<!-- 아이템항목상세뷰 -->
	<select id="getItemView" parameterType="box" resultType="box">
		SELECT 
			A.id
			, A.inquiry_id
			, A.item_sentence
			, A.item_no
			, A.col_no
			, A.item_type
			, A.estimation_yn
			, A.reverse_score_yn
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, C.code_nm as item_type_nm
		FROM TB_INQUIRY_ITEM A
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
			LEFT OUTER JOIN SV_CODE C ON C.UP_CODE = 'ITEM_TYPE' AND C.CODE = A.ITEM_TYPE
		WHERE 	A.id = #{id}
	</select>
	
	<!-- 아이템항목들 Count -->
	<select id="getSortCount" parameterType="box" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_INQUIRY_ITEM
		WHERE 	INQUIRY_ID = #{s_inquiry_id}
	</select>
	
	<!-- 아이템항목들 Count -->
	<select id="getColCount" parameterType="box" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_INQUIRY_ITEM T1 INNER JOIN TB_INQUIRY T2 ON T1.INQUIRY_ID=T2.ID
		WHERE 	T2.SURVEY_ID = #{s_survey_id}
	</select>
	
	<!-- 현재 아이템항목을 참조하는 답변이 있는지 Count -->
	<select id="lowDepthCount" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_ITEM_ANSWER
		WHERE ITEM_ID = #{s_item_id}
	</select>
	
	<!-- 아이템항목 Insert -->
	<insert id="itemInsert" parameterType="box">
	   INSERT INTO TB_INQUIRY_ITEM (inquiry_id, item_sentence, item_no, col_no, item_type, estimation_yn, reverse_score_yn, reg_id, reg_dt,edit_id,edit_dt)  VALUES 
	        (#{inquiry_id}, trim(#{item_sentence}), #{item_no}, #{col_no}, #{item_type}, #{estimation_yn}, #{reverse_score_yn},#{mem_id},now(),#{mem_id},now())
	</insert>
	
	<!-- 아이템항목 정렬 스텝1 Update -->
	<update id="sortItem1" parameterType="box" >
	   UPDATE TB_INQUIRY_ITEM set item_no = item_no * 1000 
	   WHERE INQUIRY_ID = #{s_inquiry_id}
	</update>
	
	<!-- 아이템항목 정렬 스텝2 Update  -->
	<update id="sortItem2" parameterType="box" >
	   UPDATE TB_INQUIRY_ITEM set item_no = ${num} * 1000 
	   <choose>
	   	<when test="pnum &lt;= num">
	   		+1
	   	</when>
	   	<when test="original_no != '' and original_no &lt; num">
	   		+1
	   	</when>
	   	<otherwise>
	   		-1
	   	</otherwise>
	   </choose>
	   WHERE ID = #{id}
	</update>
	
	<!-- 아이템항목 정렬 스텝3 Update  -->
	<update id="sortItem3" parameterType="box">
	   UPDATE TB_INQUIRY_ITEM set item_no = ${item_no}
	   WHERE ID = #{id}
	</update>

	
	<!-- 아이템답안지번호 정렬 스텝1 Update -->
	<update id="sortColNum1" parameterType="box" >
	   UPDATE TB_INQUIRY_ITEM T1 set col_no = col_no * 1000 
	   WHERE 	EXISTS (SELECT * FROM TB_INQUIRY T2 WHERE T1.INQUIRY_ID=T2.ID AND T2.SURVEY_ID = #{s_survey_id})
	</update>
	
	<!-- 아이템답안지번호 정렬 스텝2 Update  -->
	<update id="sortColNum2" parameterType="box" >
	   UPDATE TB_INQUIRY_ITEM set col_no = ${colNum} * 1000 
	   <choose>
	   	<when test="maxColNum &lt;= colNum">
	   		+1
	   	</when>
	   	<when test="original_col_no != '' and original_col_no &lt; colNum">
	   		+1
	   	</when>
	   	<otherwise>
	   		-1
	   	</otherwise>
	   </choose>
	   WHERE ID = #{id}
	</update>
	
	<!-- 아이템항목 정렬 스텝3 Update  -->
	<update id="sortColNum3" parameterType="box">
	   UPDATE TB_INQUIRY_ITEM set col_no = ${col_no}
	   WHERE ID = #{id}
	</update>

	<!-- 아이템항목 Update -->
	<update id="itemUpdate" parameterType="box" >
	   UPDATE TB_INQUIRY_ITEM set
		   INQUIRY_ID = #{inquiry_id}
		   ,ITEM_SENTENCE = #{item_sentence}
		   ,ITEM_NO = #{item_no}
		   ,ITEM_TYPE = #{item_type}
		   ,ESTIMATION_YN = #{estimation_yn}
		   ,REVERSE_SCORE_YN = #{reverse_score_yn}
		   ,EDIT_ID = #{mem_id}
		   ,EDIT_DT = now()
	   WHERE ID = #{id}
	</update>
	
	<!-- 아이템항목 Delete -->
	<delete id="itemDelete" parameterType="box">
	   DELETE FROM TB_INQUIRY_ITEM
	   WHERE ID = #{id}
	</delete>
</mapper>
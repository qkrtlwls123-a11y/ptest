<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HolderSummary">
	<sql id="summary_list_where">
		<if test="s_recruit_survey_id != null and s_recruit_survey_id != '' ">
			<!-- AND TT3.recruit_survey_id LIKE CONCAT('%', #{s_recruit_survey_id}, '%') -->
		</if>
		<if test="s_survey_nm != null and s_survey_nm != '' ">
			AND TT3.survey_nm LIKE CONCAT('%', #{s_survey_nm}, '%')
		</if>
		<if test="s_user_nm != null and s_user_nm != '' ">
			AND TT2.user_nm LIKE CONCAT('%', #{s_user_nm}, '%')
		</if>
		<if test="s_company_code != null and s_company_code != '' ">
			AND TT2.company_code = #{s_company_code}
		</if>
		<if test="s_belong_code != null and s_belong_code != '' ">
			AND TT2.belong_code = #{s_belong_code}
		</if>
		<if test="s_holder_type != null and s_holder_type == 'representative' ">
			AND TT11.user_id is not null
		</if>
		<if test="s_holder_type != null and s_holder_type == 'similar' ">
			AND TT13.user_id is not null
		</if>
	</sql>
		
	<!-- 재직자설문통계조회 -->
	<select id="getHolderSummaryList" parameterType="box" resultType="box">
		SELECT
			 TT1.responder_id
		    , TT2.user_nm
		    , TT4.code_nm as company_nm
		    , TT2.area
		    , TT5.code_nm as belong_nm
		    , TT6.code_nm as position_nm
		    , TT7.code_nm as job_nm
		    , TT8.code_nm as duty_nm
		    , TT9.code_nm as gender_nm
		    , TT10.code_nm as recruit_nm
		    , ROUND(TT1.sten_va1,2) as va1
		    , ROUND(TT1.sten_va2,2) as va2
		    , ROUND(TT1.sten_va3,2) as va3
		    , ROUND(TT1.sten_va4,2) as va4
		    , ROUND(TT1.sten_iso,2) as iso
		    , ROUND(TT1.sten_pas,2) as pas
		    , ROUND(TT1.sten_rkt,2) as rkt
		    , ROUND(TT1.sten_ect,2) as ect
		    , ROUND(TT1.sten_nar,2) as nar
		    , ROUND(TT1.sten_pow,2) as pow
		    , ROUND(TT1.sten_sst,2) as sst
		    , ROUND(TT1.sten_ats,2) as ats
		    <if test="s_recruit_survey_id != null and s_recruit_survey_id != '' ">
		    , TT11.user_id as representative_yn
		    , TT13.user_id as similar_yn
		    </if>
			, TT1.reg_id
			, DATE_FORMAT(TT1.reg_dt, '%Y-%m-%d') as reg_dt
		FROM TB_HOLDER_SUMMARY TT1 INNER JOIN SV_USER TT2 ON TT2.ID = TT1.RESPONDER_ID 
		<if test="s_recruit_survey_id != null and s_recruit_survey_id != '' ">
			INNER JOIN SV_RECRUIT_SURVEY TT3 ON TT3.ID = #{s_recruit_survey_id}
		</if>
			LEFT OUTER JOIN SV_CODE TT4 ON TT4.UP_CODE = 'COMPANY' AND TT4.CODE = TT2.COMPANY_CODE
			LEFT OUTER JOIN SV_CODE TT5 ON TT5.UP_CODE = 'BELONG' AND TT5.CODE = TT2.BELONG_CODE
			LEFT OUTER JOIN SV_CODE TT6 ON TT6.UP_CODE = 'POSITION_TYPE' AND TT6.CODE = TT2.POSITION_CODE
			LEFT OUTER JOIN SV_CODE TT7 ON TT7.UP_CODE = 'JOB_TYPE' AND TT7.CODE = TT2.JOB_CODE
			LEFT OUTER JOIN SV_CODE TT8 ON TT8.UP_CODE = 'DUTY_TYPE' AND TT8.CODE = TT2.DUTY_CODE
			LEFT OUTER JOIN SV_CODE TT9 ON TT9.UP_CODE = 'GENDER_TYPE' AND TT9.CODE = TT2.GENDER_CODE
			LEFT OUTER JOIN SV_CODE TT10 ON TT10.UP_CODE = 'RECRUIT_TYPE' AND TT10.CODE = TT2.RECRUIT_CODE
			<if test="s_recruit_survey_id != null and s_recruit_survey_id != '' ">
				LEFT OUTER JOIN SV_REPRESENTATIVE_USER TT11 ON TT1.RESPONDER_ID = TT11.USER_ID AND TT11.RECRUIT_SURVEY_ID  = #{s_recruit_survey_id}
				LEFT OUTER JOIN SV_SIMILAR_USER TT13 ON TT1.RESPONDER_ID = TT13.USER_ID AND TT13.RECRUIT_SURVEY_ID  = #{s_recruit_survey_id}
			</if>
			WHERE 1=1
		<include refid="summary_list_where"/>
		ORDER BY TT1.RESPONDER_ID DESC,TT1.REG_DT DESC
		LIMIT ${numPerPage} OFFSET ${startRow}
	</select>

	<select id="getHolderSummaryListCount" parameterType="box" resultType="Integer">
		SELECT
			 COUNT(*) AS TOTAL_CNT
		FROM
			TB_HOLDER_SUMMARY TT1 INNER JOIN SV_USER TT2 ON TT1.RESPONDER_ID = TT2.ID
			LEFT OUTER JOIN SV_REPRESENTATIVE_USER TT11 ON TT1.RESPONDER_ID = TT11.USER_ID AND TT11.RECRUIT_SURVEY_ID  = #{s_recruit_survey_id}
			LEFT OUTER JOIN SV_SIMILAR_USER TT13 ON TT1.RESPONDER_ID = TT13.USER_ID AND TT13.RECRUIT_SURVEY_ID  = #{s_recruit_survey_id}
		WHERE 1=1
		<include refid="summary_list_where"/>
	</select>
	
	<!-- 설문상세뷰 -->
	<select id="getHolderSummaryView" parameterType="box" resultType="box">
		SELECT 
			responder_id
		    ,sten_va1
		    ,sten_va2
		    ,sten_va3
		    ,sten_va4
		    ,sten_iso
		    ,sten_pas
		    ,sten_rkt
		    ,sten_ect
		    ,sten_nar
		    ,sten_pow
		    ,sten_sst
		    ,sten_ats
			,reg_id
			,DATE_FORMAT(reg_dt, '%Y-%m-%d') as reg_dt
		FROM TB_HOLDER_SUMMARY
		WHERE responder_id = #{responder_id}
	</select>
	
	<!-- 설문 Insert -->
	<insert id="holderSummaryInsert" parameterType="box">
	   INSERT INTO TB_HOLDER_SUMMARY (
	   		survey_id
		   , responder_id
		   , sten_va1
		   , sten_va2
		   , sten_va3
		   , sten_va4
		   , sten_iso
		   , sten_pas
		   , sten_rkt
		   , sten_ect
		   , sten_nar
		   , sten_pow
		   , sten_sst
		   , sten_ats
		   , reg_id
		   , reg_dt
	   	)VALUES (
			#{survey_id}
		   , #{responder_id}
		   , #{sten_va1}
		   , #{sten_va2}
		   , #{sten_va3}
		   , #{sten_va4}
		   , #{sten_iso}
		   , #{sten_pas}
		   , #{sten_rkt}
		   , #{sten_ect}
		   , #{sten_nar}
		   , #{sten_pow}
		   , #{sten_sst}
		   , #{sten_ats}
		   , #{mem_id}
		   , now()
	   	)
	</insert>
	
	<!-- holderSummary update -->
	<update id="holderSummaryUpdate" parameterType="box">
	   UPDATE TB_HOLDER_SUMMARY SET sten_va1 = #{sten_va1}
		   , sten_va2 = #{sten_va2}
		   , sten_va3 = #{sten_va3}
		   , sten_va4 = #{sten_va4}
		   , sten_iso = #{sten_iso}
		   , sten_pas = #{sten_pas}
		   , sten_rkt = #{sten_rkt}
		   , sten_ect = #{sten_ect}
		   , sten_nar = #{sten_nar}
		   , sten_pow = #{sten_pow}
		   , sten_sst = #{sten_sst}
		   , sten_ats = #{sten_ats}
		   , reg_id = #{mem_id}
		   , reg_dt = now()
	   	WHERE RESPONDER_ID = #{responder_id}
	</update>	
		
	<!-- 유사구성원상세뷰 -->
	<select id="getRepresentativeUserView" parameterType="box" resultType="box">
		SELECT 
			recruit_survey_id
		    ,user_id
		FROM SV_REPRESENTATIVE_USER
		WHERE RECRUIT_SURVEY_ID = #{recruit_survey_id} AND USER_ID = #{responder_id}
	</select>
	
	<!-- 설문 대표구성원 insert -->
	<insert id="setRepresentativeUser" parameterType="box" >
	   INSERT INTO SV_REPRESENTATIVE_USER(RECRUIT_SURVEY_ID,USER_ID)
	   VALUES(#{recruit_survey_id},#{responder_id}) 
	</insert>
	
	<!-- 유사구성원 UNSET -->
	<delete id="unSetRepresentativeUser" parameterType="box">
	   DELETE FROM SV_REPRESENTATIVE_USER
	   WHERE RECRUIT_SURVEY_ID = #{recruit_survey_id} 
	</delete>
	
	<!-- 설문 Delete -->
	<delete id="holderSummaryDelete" parameterType="box">
	   DELETE FROM TB_HOLDER_SUMMARY
	   WHERE RESPONDER_ID = #{id}
	</delete>
	
	<!-- 대표구성원 Delete -->
	<delete id="representativeUserDelete" parameterType="box">
	   DELETE FROM SV_REPRESENTATIVE_USER
	   WHERE USER_ID = #{id}
	</delete>
	
	<!-- 유사구성원 Delete -->
	<delete id="similarUserDelete" parameterType="box">
	   DELETE FROM SV_SIMILAR_USER
	   WHERE USER_ID = #{id} 
	</delete>
	
	<!-- 유사구성원 UNSET -->
	<delete id="unSetSimilarUser" parameterType="box">
	   DELETE FROM SV_SIMILAR_USER
	   WHERE RECRUIT_SURVEY_ID = #{recruit_survey_id} AND USER_ID = #{responder_id} 
	</delete>
	
	<!-- 유사구성원 SET -->
	<insert id="setSimilarUser" parameterType="box">
	   INSERT INTO SV_SIMILAR_USER(RECRUIT_SURVEY_ID,USER_ID)
	   VALUES(#{recruit_survey_id},#{responder_id}) 
	</insert>
	
	<!-- 유사구성원상세뷰 -->
	<select id="getSimilarUserView" parameterType="box" resultType="box">
		SELECT 
			recruit_survey_id
		    ,user_id
		FROM SV_SIMILAR_USER
		WHERE RECRUIT_SURVEY_ID = #{recruit_survey_id} AND USER_ID = #{responder_id}
	</select>
	
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Inquiry">
	<sql id="inquiry_list_where">
		<if test="s_inquiry_sentence != null and s_inquiry_sentence != '' ">
			AND A.INQUIRY_SENTENCE LIKE CONCAT('%', #{s_inquiry_sentence}, '%')
		</if>
		<if test="s_inquiry_type != null and s_inquiry_type != '' ">
			AND A.INQUIRY_TYPE = #{s_inquiry_type}
		</if>
		<if test="s_survey_id != null and s_survey_id != '' ">
			AND A.SURVEY_ID = #{s_survey_id}
		</if>
	</sql>
	
	<!-- 전체질의조회 -->
	<select id="selectInquiryList" parameterType="box" resultType="box">
		SELECT
			 A.id
			, A.survey_id
			, A.inquiry_sentence
			, A.inquiry_no
			, A.inquiry_type
			, (SELECT COUNT(*) FROM TB_INQUIRY TT1 WHERE TT1.survey_id = A.survey_id AND TT1.inquiry_type = A.inquiry_type) AS inquiry_max_no
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, C.code_nm as inquiry_type_nm
		FROM TB_INQUIRY A
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
			LEFT OUTER JOIN SV_CODE C ON C.UP_CODE = 'INQUIRY_TYPE' AND C.CODE = A.INQUIRY_TYPE
			WHERE 1=1
		<include refid="inquiry_list_where"/>
		ORDER BY inquiry_type,inquiry_no
		LIMIT ${numPerPage} OFFSET ${startRow}
	</select>

	<select id="selectInquiryListCount" parameterType="box" resultType="Integer">
		SELECT
			 COUNT(*) AS TOTAL_CNT
		FROM TB_INQUIRY A
		WHERE 1=1
		<include refid="inquiry_list_where"/>
	</select>
	
	<!-- autoSort용 질의리스트  -->
	<select id="getSortInquiryList" parameterType="box" resultType="box">
		SELECT id
		FROM TB_INQUIRY
		WHERE SURVEY_ID = #{s_survey_id}
	   AND INQUIRY_TYPE = #{s_inquiry_type}
		ORDER BY INQUIRY_NO ASC
	</select>
	
	<!-- 질의상세뷰 -->
	<select id="getInquiryView" parameterType="box" resultType="box">
		SELECT 
			 A.id
			, A.survey_id
			, A.inquiry_sentence
			, A.inquiry_no
			, A.inquiry_type
			, A.reg_id
			, DATE_FORMAT(A.reg_dt, '%Y-%m-%d') as reg_dt
			, A.edit_id
			, DATE_FORMAT(A.edit_dt, '%Y-%m-%d') as edit_dt
			, D.user_nm as edit_nm
			, C.code_nm as inquiry_type_nm
		FROM TB_INQUIRY A
			LEFT OUTER JOIN SV_USER D ON A.EDIT_ID = D.ID
			LEFT OUTER JOIN SV_CODE C ON C.UP_CODE = 'INQUIRY_TYPE' AND C.CODE = A.INQUIRY_TYPE
		WHERE 	A.id = #{id}
	</select>
	
	<!-- 현 뎁스 질의들 Count -->
	<select id="getSortCount" parameterType="box" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_INQUIRY
		WHERE 	SURVEY_ID = #{s_survey_id}
		AND INQUIRY_TYPE = #{s_inquiry_type}
	</select>
	
	<!-- 현재 질의를 참조하는 질의아이템이 있는지 Count -->
	<select id="lowDepthCount" resultType="Integer">
		SELECT 
			COUNT(*) AS cnt
		FROM TB_INQUIRY_ITEM
		WHERE INQUIRY_ID = #{s_inquiry_id}
	</select>
	
	<!-- 질의 Insert -->
	<insert id="inquiryInsert" parameterType="box">
	   INSERT INTO TB_INQUIRY (survey_id, inquiry_sentence, inquiry_no, inquiry_type, reg_id, reg_dt,edit_id,edit_dt)  VALUES 
	        (#{survey_id}, trim(#{inquiry_sentence}), #{inquiry_no}, #{inquiry_type},#{mem_id},now(),#{mem_id},now())
	</insert>
	
	<!-- 질의 정렬 스텝1 Update -->
	<update id="sortInquiry1" parameterType="box" >
	   UPDATE TB_INQUIRY set inquiry_no = inquiry_no * 1000 
	   WHERE SURVEY_ID = #{s_survey_id}
	   AND INQUIRY_TYPE = #{s_inquiry_type}
	</update>
	
	<!-- 질의 정렬 스텝2 Update  -->
	<update id="sortInquiry2" parameterType="box" >
	   UPDATE TB_INQUIRY set inquiry_no = ${num} * 1000 
	   <choose>
	   	<when test="pnum &lt;= num">
	   		+1
	   	</when>
	   	<when test="original_inquiry_no != '' and original_inquiry_no &lt; num">
	   		+1
	   	</when>
	   	<otherwise>
	   		-1
	   	</otherwise>
	   </choose>
	   WHERE ID = #{id}
	</update>
	
	<!-- 질의 정렬 스텝3 Update  -->
	<update id="sortInquiry3" parameterType="box">
	   UPDATE TB_INQUIRY set inquiry_no = ${inquiry_no}
	   WHERE ID = #{id}
	</update>
	
	<!-- 질의 Update -->
	<update id="inquiryUpdate" parameterType="box" >
	   UPDATE TB_INQUIRY set
		   SURVEY_ID = #{survey_id}
		   ,INQUIRY_SENTENCE = #{inquiry_sentence}
		   ,INQUIRY_NO = #{inquiry_no}
		   ,INQUIRY_TYPE = #{inquiry_type}
		   ,EDIT_ID = #{mem_id}
		   ,EDIT_DT = now()
	   WHERE ID = #{id}
	</update>
	
	<!-- 질의 Delete -->
	<delete id="inquiryDelete" parameterType="box">
	   DELETE FROM TB_INQUIRY
	   WHERE ID = #{id}
	</delete>
</mapper>